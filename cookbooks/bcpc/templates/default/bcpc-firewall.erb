#!/bin/sh
################################################
#
#              Generated by Chef
#
################################################

# To make this safe to rerun, flush rules, chains, and counters
iptables -F
iptables -X
iptables -Z

iptables-restore <<EOH
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:LOGDROP - [0:0]

<% if node['bcpc']['host_firewall'] -%>

# Allow all established stuff to keep going
-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# Allow icmp
-A INPUT -p icmp -j ACCEPT

###########################
# Storage network ACLs
###########################

# Allow hosts to talk freely to each other on storage network
-A INPUT -i <%=@node["bcpc"]["storage"]["interface"]%> -d <%=@node["bcpc"]["storage"]["cidr"]%> -s <%=@node["bcpc"]["storage"]["cidr"]%> -j ACCEPT

# Log and drop everything else
-A INPUT -i <%=@node["bcpc"]["storage"]["interface"]%> -j LOGDROP

###########################
# Floating network ACLs
###########################

# Allow anyone to ingress float iface to the float addresses
-A INPUT -i <%=@node["bcpc"]["floating"]["interface"]%> -d <%=@node["bcpc"]["floating"]["cidr"]%> -j ACCEPT

# Allow vrrp traffic
-A INPUT -i <%=@node["bcpc"]["floating"]["interface"]%> -p vrrp -j ACCEPT

# Log and drop everything else
-A INPUT -i <%=@node["bcpc"]["floating"]["interface"]%> -j LOGDROP

###########################
# Management network ACLs
###########################

# Allow vrrp traffic
-A INPUT -i <%=@node["bcpc"]["management"]["interface"]%> -p vrrp -j ACCEPT

# Allow external access to some mgmt network ports on each hypervisor
## ssh
-A INPUT -i <%=@node["bcpc"]["management"]["interface"]%> -d <%=@node["bcpc"]["management"]["ip"]%> -p tcp --dport 22 -j ACCEPT
## nova-novncproxy
-A INPUT -i <%=@node["bcpc"]["management"]["interface"]%> -d <%=@node["bcpc"]["management"]["ip"]%> -p tcp --dport 6080 -j ACCEPT

# Allow external access to some VIP services
## apache
-A INPUT -i <%=@node["bcpc"]["management"]["interface"]%> -d <%=@node["bcpc"]["management"]["vip"]%> -p tcp --dport 80 -j ACCEPT
-A INPUT -i <%=@node["bcpc"]["management"]["interface"]%> -d <%=@node["bcpc"]["management"]["vip"]%> -p tcp --dport 443 -j ACCEPT
## keystone
-A INPUT -i <%=@node["bcpc"]["management"]["interface"]%> -d <%=@node["bcpc"]["management"]["vip"]%> -p tcp --dport 5000 -j ACCEPT
-A INPUT -i <%=@node["bcpc"]["management"]["interface"]%> -d <%=@node["bcpc"]["management"]["vip"]%> -p tcp --dport 35357 -j ACCEPT
## glance
-A INPUT -i <%=@node["bcpc"]["management"]["interface"]%> -d <%=@node["bcpc"]["management"]["vip"]%> -p tcp --dport 9292 -j ACCEPT
## cinder
-A INPUT -i <%=@node["bcpc"]["management"]["interface"]%> -d <%=@node["bcpc"]["management"]["vip"]%> -p tcp --dport 8776 -j ACCEPT
## nova-api-ec2
-A INPUT -i <%=@node["bcpc"]["management"]["interface"]%> -d <%=@node["bcpc"]["management"]["vip"]%> -p tcp --dport 8773 -j ACCEPT
## nova-api
-A INPUT -i <%=@node["bcpc"]["management"]["interface"]%> -d <%=@node["bcpc"]["management"]["vip"]%> -p tcp --dport 8774 -j ACCEPT
## heat-api
-A INPUT -i <%=@node["bcpc"]["management"]["interface"]%> -d <%=@node["bcpc"]["management"]["vip"]%> -p tcp --dport 8004 -j ACCEPT
## heat-api-cfn
-A INPUT -i <%=@node["bcpc"]["management"]["interface"]%> -d <%=@node["bcpc"]["management"]["vip"]%> -p tcp --dport 8000 -j ACCEPT
## ceilometer-api
-A INPUT -i <%=@node["bcpc"]["management"]["interface"]%> -d <%=@node["bcpc"]["management"]["vip"]%> -p tcp --dport 8777 -j ACCEPT
## powerdns
-A INPUT -i <%=@node["bcpc"]["management"]["interface"]%> -d <%=@node["bcpc"]["management"]["vip"]%> -p udp --dport 53 -j ACCEPT
-A INPUT -i <%=@node["bcpc"]["management"]["interface"]%> -d <%=@node["bcpc"]["management"]["vip"]%> -p tcp --dport 53 -j ACCEPT

# Allow hosts to talk freely to each other on mgmt network
-A INPUT -i <%=@node["bcpc"]["management"]["interface"]%> -d <%=@node["bcpc"]["management"]["cidr"]%> -s <%=@node["bcpc"]["management"]["cidr"]%> -j ACCEPT

# Log and drop everything else
-A INPUT -i <%=@node["bcpc"]["management"]["interface"]%> -j LOGDROP

<% end -%>

###########################
# Log and drop chain
###########################

# Log before we drop the bad traffic
-A LOGDROP -p tcp -m limit --limit 5/min -j LOG --log-prefix "Denied TCP: " --log-level 7
-A LOGDROP -p udp -m limit --limit 5/min -j LOG --log-prefix "Denied UDP: " --log-level 7
-A LOGDROP -p icmp -m limit --limit 5/min -j LOG --log-prefix "Denied ICMP: " --log-level 7
-A LOGDROP -j DROP

COMMIT
EOH
