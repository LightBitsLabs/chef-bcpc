################################################
#
#              Generated by Chef
#
################################################

##
## mysqld options _MANDATORY_ for correct opration of the cluster
##
[mysqld]

datadir=/var/lib/mysql

# (This must be substituted by wsrep_format)
binlog_format=ROW

# Currently only InnoDB storage engine is supported
default-storage-engine=innodb

# to avoid issues with 'bulk mode inserts' using autoinc
innodb_autoinc_lock_mode=2

# This is a must for parallel applying
innodb_locks_unsafe_for_binlog=1

# Memory area where InnoDB caches table and index data. Default is 128M.
innodb_buffer_pool_size=<%= @innodb_buffer_pool_size %>

# Number of buffer pool instances. Only takes effect if pool size is 1GB+.
innodb_buffer_pool_instances=<%= @innodb_buffer_pool_instances %>

<% if not @thread_cache_size.nil? %>
thread_cache_size=<%= @thread_cache_size %>
<% end %>
innodb_io_capacity=<%= @innodb_io_capacity %>

# Less thrash on restarts by dumping and loading buffer pools
innodb_buffer_pool_dump_at_shutdown=ON
innodb_buffer_pool_load_at_startup=ON

# Write to disk and flush once per second
innodb_flush_log_at_trx_commit=0

# Put each table in it's own file
innodb_file_per_table=1

# Set log file larger than the 5M default
innodb_log_file_size=64M

# Set memory buffer size for the log
innodb_log_buffer_size=<%= @innodb_log_buffer_size %>

# Use direct I/O to avoid double buffering writes
# note: 'O_DIRECT_NO_FSYNC' should not be used with XFS file system
innodb_flush_method=<%= @innodb_flush_method %>

# Query Cache is not supported with wsrep
query_cache_size=0
query_cache_type=0

# Override bind-address
# In some systems bind-address defaults to 127.0.0.1, and with mysqldump SST
# it will have (most likely) disastrous consequences on donor node
bind-address=<%=node['bcpc']['management']['ip']%>
max_connections=<%= @max_connections %>

# Defaults that most openstack bits are happy with
collation-server = utf8_general_ci
init-connect='SET NAMES utf8'
character-set-server = utf8

# We create lots of temp tables both on disk and in memory.
# Increase size of memory temp tables
max_heap_table_size = <%= @max_heap_table_size %>
tmp_table_size = <%= @tmp_table_size %>

# We also need to increase some buffer sizes
join_buffer_size = <%= @join_buffer_size %>
sort_buffer_size = <%= @sort_buffer_size %>

##
## Slow query log options
##
slow_query_log=<%= @slow_query_log ? '1' : '0' %>
slow_query_log_file=<%= @slow_query_log_file %>
long_query_time=<%= @long_query_time %>
log_queries_not_using_indexes=<%= @log_queries_not_using_indexes ? '1' : '0' %>
